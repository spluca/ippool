# GitLab CI/CD Pipeline for IP Pool API
#
# This pipeline:
# - Runs tests and linting on every commit
# - Builds Docker images and pushes to GitLab Container Registry
# - Tags images as 'latest' on main/master branch
# - Creates versioned releases from git tags
#
# Container Registry: ${CI_REGISTRY_IMAGE}
# Example: registry.gitlab.com/username/ippool
#
# GitLab automatically provides these variables:
# - CI_REGISTRY: GitLab Container Registry URL
# - CI_REGISTRY_IMAGE: Full image path (registry + project)
# - CI_REGISTRY_USER: Username (gitlab-ci-token)
# - CI_REGISTRY_PASSWORD: Temporary token for authentication

stages:
  - diagnose
  - test
  - build
  - release

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: "1"
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  # GitLab Container Registry (manually defined because instance doesn't provide them)
  CI_REGISTRY: "git.spluca.org:5050"
  CI_REGISTRY_IMAGE: "git.spluca.org:5050/${CI_PROJECT_PATH}"
  IMAGE_TAG: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}
  IMAGE_LATEST: ${CI_REGISTRY_IMAGE}:latest

# Diagnose network connectivity
diagnose:
  stage: diagnose
  image: alpine:latest
  before_script:
    - apk add --no-cache curl bind-tools netcat-openbsd
  script:
    - echo "=== Network Diagnostics ==="
    - echo "Resolving ${CI_REGISTRY}..."
    - nslookup git.spluca.org || echo "DNS resolution failed"
    - echo "Testing connectivity to ${CI_REGISTRY}..."
    - nc -zv -w5 git.spluca.org 5050 || echo "Port 5050 not accessible"
    - echo "Testing HTTPS endpoint..."
    - curl -k -I --connect-timeout 10 https://${CI_REGISTRY}/v2/ || echo "HTTPS endpoint not accessible"
    - echo "Testing HTTP endpoint..."
    - curl -I --connect-timeout 10 http://${CI_REGISTRY}/v2/ || echo "HTTP endpoint not accessible"
  rules:
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

# Cache for Rust dependencies
.cargo_cache: &cargo_cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-cargo
    paths:
      - .cargo/
      - target/

# Test stage
test:
  stage: test
  image: rust:1.91.1-alpine
  <<: *cargo_cache
  before_script:
    - apk add --no-cache musl-dev
  script:
    - cargo test --verbose
    - cargo test --release --verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Lint and format check
lint:
  stage: test
  image: rust:1.91.1-alpine
  <<: *cargo_cache
  before_script:
    - apk add --no-cache musl-dev
    - rustup component add rustfmt clippy
  script:
    - cargo fmt -- --check
    - cargo clippy -- -D warnings
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build Docker image
build:
  stage: build
  image: docker:29-cli
  services:
    - name: docker:29-dind
      alias: docker
      command: ["--tls=true", "--insecure-registry=git.spluca.org:5050"]
  variables:
    DOCKER_HOST: tcp://docker:2376
  before_script:
    - echo "waiting for docker daemon to generate tls certificates..."
    - until docker info >/dev/null 2>&1; do sleep 1; done
    - echo "docker daemon ready"
    - echo "=== Debug Info ==="
    - echo "CI_REGISTRY=${CI_REGISTRY}"
    - echo "CI_PROJECT_PATH=${CI_PROJECT_PATH}"
    - echo "CI_REGISTRY_IMAGE=${CI_REGISTRY_IMAGE}"
    - echo "IMAGE_TAG=${IMAGE_TAG}"
    - echo "CI_REGISTRY_USER=${CI_REGISTRY_USER}"
    - echo "=================="
    - echo "Configuring insecure registry ${CI_REGISTRY}"
    - apk add --no-cache openssl ca-certificates curl
    - update-ca-certificates
    - |
      if [ -n "${CI_REGISTRY}" ]; then
        REGISTRY_HOST=$(echo ${CI_REGISTRY} | cut -d':' -f1)
        REGISTRY_PORT=$(echo ${CI_REGISTRY} | cut -d':' -f2)
        echo "Registry host: ${REGISTRY_HOST}:${REGISTRY_PORT}"
        mkdir -p /etc/docker/certs.d/${CI_REGISTRY}
        
        # Try to get certificate if HTTPS is available
        echo "Testing registry endpoint..."
        if curl -k -I --connect-timeout 5 https://${CI_REGISTRY}/v2/ 2>/dev/null; then
          echo "HTTPS registry detected, downloading certificate..."
          echo -n | openssl s_client -connect ${REGISTRY_HOST}:${REGISTRY_PORT} -servername ${REGISTRY_HOST} 2>&1 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /etc/docker/certs.d/${CI_REGISTRY}/ca.crt || echo "Failed to get cert"
        else
          echo "Registry not accessible via HTTPS, will use insecure registry configuration"
        fi
      fi
    - echo "Logging in to GitLab Container Registry at ${CI_REGISTRY}"
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - echo "Building image ${IMAGE_TAG}"
    - docker build -t ${IMAGE_TAG} .
    - echo "Pushing image to GitLab Container Registry"
    - docker push ${IMAGE_TAG}
  rules:
    - if: $CI_COMMIT_BRANCH
  dependencies: []

# Tag as latest on main branch
release:latest:
  stage: release
  image: docker:29-cli
  services:
    - name: docker:29-dind
      alias: docker
      command: ["--tls=true", "--insecure-registry=git.spluca.org:5050"]
  variables:
    DOCKER_HOST: tcp://docker:2376
  before_script:
    - echo "waiting for docker daemon to generate tls certificates..."
    - until docker info >/dev/null 2>&1; do sleep 1; done
    - echo "docker daemon ready"
    - echo "Configuring insecure registry ${CI_REGISTRY}"
    - apk add --no-cache openssl ca-certificates
    - update-ca-certificates
    - |
      if [ -n "${CI_REGISTRY}" ]; then
        REGISTRY_HOST=$(echo ${CI_REGISTRY} | cut -d':' -f1)
        REGISTRY_PORT=$(echo ${CI_REGISTRY} | cut -d':' -f2)
        mkdir -p /etc/docker/certs.d/${CI_REGISTRY}
        
        # Try to get certificate if HTTPS is available
        if curl -k -I --connect-timeout 5 https://${CI_REGISTRY}/v2/ 2>/dev/null; then
          echo -n | openssl s_client -connect ${REGISTRY_HOST}:${REGISTRY_PORT} -servername ${REGISTRY_HOST} 2>&1 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /etc/docker/certs.d/${CI_REGISTRY}/ca.crt || echo "Failed to get cert"
        fi
      fi
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - docker pull ${IMAGE_TAG}
    - docker tag ${IMAGE_TAG} ${IMAGE_LATEST}
    - docker push ${IMAGE_LATEST}
  only:
    - main
  dependencies: []

# Tag semantic versions
release:tag:
  stage: release
  image: docker:29-cli
  services:
    - name: docker:29-dind
      alias: docker
      command: ["--tls=true", "--insecure-registry=git.spluca.org:5050"]
  variables:
    DOCKER_HOST: tcp://docker:2376
  before_script:
    - echo "waiting for docker daemon to generate tls certificates..."
    - until docker info >/dev/null 2>&1; do sleep 1; done
    - echo "docker daemon ready"
    - echo "Configuring insecure registry ${CI_REGISTRY}"
    - apk add --no-cache openssl ca-certificates
    - update-ca-certificates
    - |
      if [ -n "${CI_REGISTRY}" ]; then
        REGISTRY_HOST=$(echo ${CI_REGISTRY} | cut -d':' -f1)
        REGISTRY_PORT=$(echo ${CI_REGISTRY} | cut -d':' -f2)
        mkdir -p /etc/docker/certs.d/${CI_REGISTRY}
        
        # Try to get certificate if HTTPS is available
        if curl -k -I --connect-timeout 5 https://${CI_REGISTRY}/v2/ 2>/dev/null; then
          echo -n | openssl s_client -connect ${REGISTRY_HOST}:${REGISTRY_PORT} -servername ${REGISTRY_HOST} 2>&1 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /etc/docker/certs.d/${CI_REGISTRY}/ca.crt || echo "Failed to get cert"
        fi
      fi
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - docker pull ${IMAGE_TAG}
    - docker tag ${IMAGE_TAG} ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    - |
      if echo ${CI_COMMIT_TAG} | grep -qE '^v?[0-9]+\.[0-9]+\.[0-9]+$'; then
        docker tag ${IMAGE_TAG} ${IMAGE_LATEST}
        docker push ${IMAGE_LATEST}
      fi
  only:
    - tags
  dependencies: []
