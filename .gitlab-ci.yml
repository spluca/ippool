stages:
  - test
  - build
  - release

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}
  IMAGE_LATEST: ${CI_REGISTRY_IMAGE}:latest

# Cache for Rust dependencies
.cargo_cache: &cargo_cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-cargo
    paths:
      - .cargo/
      - target/

# Test stage
test:
  stage: test
  image: rust:1.91.1-alpine
  <<: *cargo_cache
  before_script:
    - apk add --no-cache musl-dev
  script:
    - cargo test --verbose
    - cargo test --release --verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Lint and format check
lint:
  stage: test
  image: rust:1.91.1-alpine
  <<: *cargo_cache
  before_script:
    - apk add --no-cache musl-dev
    - rustup component add rustfmt clippy
  script:
    - cargo fmt -- --check
    - cargo clippy -- -D warnings
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Build Docker image
build:
  stage: build
  image: docker:29-cli
  services:
    - docker:29-dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - docker build -t ${IMAGE_TAG} .
    - docker push ${IMAGE_TAG}
  rules:
    - if: $CI_COMMIT_BRANCH
  dependencies: []

# Tag as latest on main branch
release:latest:
  stage: release
  image: docker:29-cli
  services:
    - docker:29-dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - docker pull ${IMAGE_TAG}
    - docker tag ${IMAGE_TAG} ${IMAGE_LATEST}
    - docker push ${IMAGE_LATEST}
  only:
    - main
  dependencies: []

# Tag semantic versions
release:tag:
  stage: release
  image: docker:29-cli
  services:
    - docker:29-dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - docker pull ${IMAGE_TAG}
    - docker tag ${IMAGE_TAG} ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    # Also tag as latest if it's a release tag
    - |
      if echo ${CI_COMMIT_TAG} | grep -qE '^v?[0-9]+\.[0-9]+\.[0-9]+$'; then
        docker tag ${IMAGE_TAG} ${IMAGE_LATEST}
        docker push ${IMAGE_LATEST}
      fi
  only:
    - tags
  dependencies: []
